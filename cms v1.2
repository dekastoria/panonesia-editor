# Panonesia Editor — **CMS v2** Full Guide (Zero‑Code, Single Page)

> **Tujuan:** Aplikasi web untuk membuat **overlay interaktif** (popup, sidebar, galeri, dll.) di atas **background 360** secara **visual tanpa coding**. Hasil akhir berupa **paket `.zip`** yang siap dipakai di platform tur virtual pihak ketiga.
>
> **Catatan v2:** Dokumen ini menyatukan rancangan zero‑code (schema‑driven, postMessage dua arah, preview cepat, diagnostics, AI assist, export ber‑CSP) dan melengkapi data dari _CMS v1_ (arsitektur hibrida, stack, desain DB, infrastruktur, contoh struktur output & fase pengembangan).

---

## Daftar Isi
1. [Arsitektur Ringkas](#arsitektur-ringkas)  
2. [UI/UX Editor (Tanpa Coding)](#uiux-editor-tanpa-coding)  
3. [Template → Schema → Auto‑Form](#template--schema--auto-form)  
4. [Format `config_json` (Output Editor)](#format-config_json-output-editor)  
5. [Protokol `postMessage` (Editor ⇄ Preview)](#protokol-postmessage-editor--preview)  
6. [Preview Runtime (iframe) & Viewer 360](#preview-runtime-iframe--viewer-360)  
7. [Diagnostics (Guardrail Pemula)](#diagnostics-guardrail-pemula)  
8. [Panel AI Assist (No‑Code Sungguhan)](#panel-ai-assist-no-code-sungguhan)  
9. [Asset Manager (Ramah Pemula)](#asset-manager-ramah-pemula)  
10. [Ekspor ZIP (Aman & Mudah Dicek)](#ekspor-zip-aman--mudah-dicek)  
11. [Acceptance Criteria (MVP)](#acceptance-criteria-mvp)  
12. [Roadmap Fase](#roadmap-fase)  
13. [Lampiran A — Data yang Diadopsi dari v1](#lampiran-a--data-yang-diadopsi-dari-v1)  
14. [Lampiran B — Contoh Berkas & Snippet](#lampiran-b--contoh-berkas--snippet)

---

## Arsitektur Ringkas

- **Filosofi Hibrida yang Disederhanakan**  
  - **Pekerjaan Admin (±90%)**: Laravel **Filament** untuk CRUD Project, Template, Asset, Versi.  
  - **Pekerjaan Inti (±10%)**: Halaman **Live Editor** khusus (React) untuk preview + interaksi cepat.
- **Stack Utama**  
  - **Backend & Admin:** Laravel 12 + Filament 4  
  - **Manajemen Asset:** Spatie Media Library (validasi tipe/ukuran; where‑used)  
  - **Editor Live:** React (Vite _atau_ Inertia) + Tailwind + shadcn/ui + Zustand (state)  
  - **Preview:** `<iframe sandbox>` (background 360 + overlay)  
  - **Komunikasi:** `window.postMessage` **dua arah** (lihat §5)  
  - **Ekspor ZIP:** ZipStream (streaming—hemat memori)  
  - **Database:** MySQL _atau_ PostgreSQL (sesuai preferensi & infrastruktur)  
  - **Infrastruktur:** VPS + **aaPanel** (hosting & manajemen server)
- **Tabel Minimal**: `projects`, `project_versions`, `templates`, `media`

---

## UI/UX Editor (Tanpa Coding)

**Layout dua kolom (resizable & disimpan di localStorage):**

**Kiri (20–28%) — Builder & Shortcuts**  
- Project bar (nama, status “Saved hh:mm”).  
- **Component Tree**: hierarki overlay (drag, duplicate, hide, delete) + **badge error** per item.  
- **+ Tambah** (wizard 3 langkah: Popup Gambar / Video / PDF / Teks).  
- Pencarian item.

**Kanan — Split vertikal**  
- **Atas: Live Preview** (iframe 360)  
  - Toolbar: Device (Mobile 375 / Tablet 768 / Desktop), Zoom, Frame toggle, Grid/Snap, Refresh, perf mini (FPS).  
  - **Two‑way select:** klik elemen di preview → fokus item & buka **Properties** di bawah.
- **Bawah: Tabs**  
  - **Properties** (default; auto dari `schema.json`)  
  - **AI** (prompt → draft config → apply sebagian/semua)  
  - **Console** (log/error dari preview)  
  - **Assets** (upload, optimasi, drag ke field)  
  - **Code** (disembunyikan di Mode Guided; untuk pengguna mahir)

**Kualitas hidup (wajib):** Autosave (debounce 150–300 ms), Undo/Redo, Command Palette (⌘K), Empty‑state dengan CTA “Tambah item pertama”.

---

## Template → Schema → Auto‑Form

**Struktur paket template:**
```
templates/<templateKey>/
  meta.json        // nama, versi
  schema.json      // definisi form & validasi → editor auto-generate UI
  template.html    // shell/slot overlay
  template.css
  template.js      // init/destroy hooks (opsional)
  assets/...
```

**Contoh `schema.json` (ringkas):**
```json
{
  "version": 1,
  "sections": [
    {
      "title": "Background 360",
      "fields": [
        {
          "key": "background360.src",
          "label": "Gambar 360",
          "type": "asset",
          "accept": [".jpg", ".jpeg", ".webp"],
          "required": true,
          "help": "Equirectangular 2:1, min 4096×2048"
        },
        { "key": "background360.yaw", "label": "Arah awal (°)", "type": "number", "min": -180, "max": 180, "step": 1, "default": 0 },
        { "key": "background360.fov", "label": "Zoom awal (FOV)", "type": "number", "min": 30, "max": 120, "step": 1, "default": 75 }
      ]
    },
    {
      "title": "Sidebar",
      "fields": [
        { "key": "sidebar.enabled", "label": "Aktifkan Sidebar", "type": "switch", "default": true },
        {
          "key": "sidebar.items",
          "label": "Menu Items",
          "type": "array",
          "itemSchema": {
            "fields": [
              { "key": "id", "label": "ID", "type": "id", "autogen": "popup-" },
              {
                "key": "type",
                "label": "Tipe",
                "type": "select",
                "options": [
                  { "label": "Popup Gambar", "value": "popup-image" },
                  { "label": "Popup Teks", "value": "popup-text" },
                  { "label": "Popup Video (YouTube)", "value": "popup-video" },
                  { "label": "Popup PDF", "value": "popup-pdf" }
                ],
                "required": true
              },
              { "key": "label", "label": "Teks Tombol", "type": "text", "required": true },
              {
                "key": "src",
                "label": "Sumber (img/pdf/YouTube ID)",
                "type": "smart",
                "required": true,
                "help": "Link gambar/PDF atau ID YouTube"
              }
            ]
          }
        }
      ]
    },
    {
      "title": "Kustom (Opsional)",
      "fields": [
        { "key": "customCode.html", "label": "HTML", "type": "code", "language": "html" },
        { "key": "customCode.css",  "label": "CSS",  "type": "code", "language": "css" },
        { "key": "customCode.js",   "label": "JS",   "type": "code", "language": "javascript" }
      ]
    }
  ]
}
```

---

## Format `config_json` (Output Editor)

```json
{
  "project": { "title": "Tur A" },
  "background360": { "src": "aset-custom/gambar/lobby.jpg", "yaw": 0, "fov": 75 },
  "sidebar": {
    "enabled": true,
    "items": [
      { "id": "popup-1", "type": "popup-image", "label": "Poster", "src": "aset-custom/gambar/poster.webp" },
      { "id": "popup-2", "type": "popup-text",  "label": "Info",   "src": "<h3>Selamat datang</h3><p>…</p>" },
      { "id": "popup-3", "type": "popup-pdf",   "label": "Menu",   "src": "aset-custom/dokumen/menu.pdf" },
      { "id": "popup-4", "type": "popup-video", "label": "Teaser", "src": "dQw4w9WgXcQ" }
    ]
  },
  "customCode": { "html": "", "css": "", "js": "" }
}
```

> **Kompatibilitas v1:** Bila sebelumnya memakai `elements[]` (mis. `type:"sidebar"` dengan `items[]` dan `link-to-popup`), sediakan **migrator** kecil: map `elements.sidebar.items[].targetId` → `sidebar.items[]` yang terbuka langsung ke popup terkait.

---

## Protokol `postMessage` (Editor ⇄ Preview)

> Semua pesan menyertakan `{ proto: "panonesia/1", requestId? }`.  
> **Gunakan patch (`update`/`bulk`) — hindari kirim full `config` tiap ketik** agar respons < 300 ms.

### Editor → Preview
| type       | Payload (ringkas)                               | Fungsi                                |
|------------|--------------------------------------------------|----------------------------------------|
| `init`     | `{ schemaVersion, templateKey, config }`         | Bootstrap pertama                      |
| `update`   | `{ path, value }`                                | **Patch granular** satu field          |
| `bulk`     | `{ patches: [{path, value}, …] }`                | Banyak patch sekaligus (debounce 150–300 ms) |
| `inspect`  | `{ nodeId }`                                     | Minta highlight komponen di canvas     |
| `refresh`  | `{ reason?: "user" \| "asset" }`                 | Hard reload runtime                    |

**Contoh path:** `sidebar.items[2].label`

### Preview → Editor
| type          | Payload (ringkas)                                         | Fungsi                                  |
|---------------|------------------------------------------------------------|------------------------------------------|
| `ready`       | `{ runtime: "panonesia@x.y.z" }`                          | Runtime siap terima pesan                |
| `select`      | `{ nodeId }`                                              | Klik di preview → fokus item di editor   |
| `log`         | `{ level: "info" \| "warn" \| "error", args: any[] }`     | **Console bridge**                       |
| `diagnostics` | `{ items: [{code, level, message, nodeId?}], ts }`        | Laporan masalah (asset 404, id ganda, dll.) |

---

## Preview Runtime (iframe) & Viewer 360

- `<iframe sandbox="allow-scripts allow-modals">` (tanpa `allow-same-origin` demi keamanan).  
- **Viewer 360 (disarankan):** **Pannellum** dengan parameter default:  
  - `src` (equirectangular 2:1), `yaw` −180..180 (default 0), `fov` 30..120 (default 75),  
  - `autoRotate` (opsional), `hotspots[]` (skema minimal).  
- **Renderer overlay:** registry komponen dengan **key stabil (`id`)**; pada `update/bulk` cukup **patch node terkait** (hindari wipe total DOM).  
- **Sanitasi** HTML custom dengan **DOMPurify** sebelum mount.

---

## Diagnostics (Guardrail Pemula)

**Berjalan terus; tampilkan badge merah bila ada error.**  
Klik item → fokus field terkait di **Properties**.

- **E001** Asset tidak ditemukan / 404  
- **E002** ID ganda atau `targetId` tidak ada  
- **E003** Format file tidak didukung  
- **E004** Gambar terlalu besar (> 8 MB) → sarankan kompres / convert WebP  
- **E005** YouTube ID tidak valid  
- **W101** FOV out‑of‑range (auto‑clamp)  
- **W102** Kontras tombol sidebar rendah (cek a11y)

---

## Panel AI Assist (No‑Code Sungguhan)

- **Wizard Prompt:** contoh _“Buat 3 menu: Poster (img), Info (teks), Brosur (PDF). Tema oranye.”_  
- **Pratinjau:** AI menghasilkan **draft config** sesuai `schema.json`.  
- **Apply:** terapkan sebagian/semua → kirim `bulk` ke preview.  
- **Per‑field:** **Rephrase / Translate** (opsional).

---

## Asset Manager (Ramah Pemula)

- Drag & drop, validasi tipe/ukuran, deteksi equirect 2:1 untuk panorama.  
- **Optimize on upload** (opsional): resize/convert WebP.  
- “Where‑used” (lihat asset dipakai di node mana).  
- Rename aman → otomatis update path di config.

---

## Ekspor ZIP (Aman & Mudah Dicek)

**Struktur folder export (rapi satu tempat):**
```
Proyek-Tur-Virtual/
├─ index.html                 ← halaman utama (viewer + overlay)
└─ aset-custom/
   ├─ css/
   │  └─ style.css           ← CSS template + CSS custom user
   ├─ js/
   │  ├─ data.js             ← CONFIG hasil editor (JSON → JS)
   │  └─ script.js           ← runtime overlay (viewer + render UI)
   ├─ gambar/
   │  └─ ...                 ← semua gambar (termasuk panorama 360)
   └─ dokumen/
      └─ ...                 ← semua PDF (dsb.)
```

**CSP default (di `<head>` `index.html`):**
```html
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  img-src 'self' data: https:;
  script-src 'self';
  style-src 'self' 'unsafe-inline';
  frame-src https://www.youtube.com https://player.vimeo.com;
">
```

**Export Preview:** tombol “Cek hasil export” membuka `export-preview.html` (opsional) agar hasil **parity** dengan editor sebelum dipakai.

**Catatan integrasi (opsi dari v1):** Bila platform tur butuh “Execute JavaScript”/hotspot trigger, sediakan helper di `script.js` (mis. `showPopup('popup-1')`) — namun **rekomendasi v2** adalah memakai `index.html` hasil export sebagai entri utama agar lebih sederhana bagi pengguna non‑teknis.

---

## Acceptance Criteria (MVP)

1) **Preview respons < 300 ms** saat edit field umum.  
2) **Two‑way selection** bekerja (klik di preview → fokus di Properties).  
3) **AI wizard** dapat membuat draft ≥ 3 item dari 1 prompt.  
4) **Diagnostics** menandai asset hilang & bisa diklik untuk memperbaiki.  
5) **Export ZIP** → hasil sama dengan preview editor.  
6) **Autosave + Undo/Redo** berjalan; indikator status “Saved”.

---

## Roadmap Fase

- **Fase 1 — Fondasi:** Laravel + Filament (Projects, Assets, Templates), auth, storage.  
- **Fase 2 — Editor:** Halaman React, schema‑driven form, postMessage (init/update/bulk/select/log), preview 360, autosave.  
- **Fase 3 — Ekspor:** Export ZIP + (opsional) `export-preview.html`, CSP default, rewriting path asset.  
- **Fase 4 — Lanjutan:** Versions timeline, template gallery, diagnostics lengkap, AI panel, hotspot lanjutan.

---

## Lampiran A — Data yang Diadopsi dari v1

- **Tujuan Proyek & Output**: visual UI builder untuk modul interaktif; output paket `.zip` siap integrasi (v1).  
- **Filosofi Hibrida**: Filament menangani admin; React fokus pada Live Editor (v1).  
- **Komponen & Stack**: Laravel 12 + Filament 4; Spatie Media Library; React + Vite/Inertia; Zustand; Tailwind + shadcn/ui; DB MySQL/PostgreSQL; ZipStream; VPS + **aaPanel** (v1).  
- **Struktur DB**: `projects`, `project_versions` (rollback), `templates`, `media` (v1).  
- **Contoh struktur output**: `Proyek-Tur-Virtual/` + `aset-custom/...` (v1).  
- **Fase pengembangan**: Fondasi → Editor → Ekspor → Lanjutan (v1).  
- **Catatan integrasi**: v1 menyarankan _Execute JavaScript_ di hotspot; v2 mensertakan opsi itu tetapi **merekomendasikan** entri langsung `index.html` agar ramah pemula.

---

## Lampiran B — Contoh Berkas & Snippet

**A. Struktur paket template (contoh)**
```
templates/radiant/
  meta.json
  schema.json
  template.html
  template.css
  template.js
  assets/
```

**B. `meta.json` (contoh)**
```json
{
  "name": "Radiant",
  "key": "radiant",
  "version": "1.0.0",
  "minRuntime": "panonesia@1.0.0"
}
```

**C. `schema.json` (salin dari contoh di bagian Template → Schema → Auto‑Form)**

**D. Pesan `postMessage` (ringkas)**
```json
{
  "proto": "panonesia/1",
  "type": "update",
  "path": "sidebar.items[2].label",
  "value": "Poster Baru"
}
```

**E. Pedoman performa**
- Debounce kirim patch 150–300 ms.  
- Hindari render ulang penuh; gunakan patch keyed nodes.  
- Lazy‑load PDF/video; kompres gambar.  
- Virtualize list jika item > 100.

---

> Dokumen satu halaman **CMS v2** ini menggantikan & merapikan versi v1. Fokus: **no‑code**, **schema‑driven**, **postMessage dua arah**, **preview cepat**, **diagnostics**, **AI assist**, serta **export ber‑CSP** dengan **parity** ke editor.
